---
date: 2020-04-05
categories: [技术,计算机通识,计算机网络]
thumbnail: /images/fe/etag.jpg
toc: true
---

# 浅谈etag
<!--more-->
ETag是一个可以与Web资源关联的记号（token）。典型的Web资源可以一个Web页，但也可能是JSON或XML文档。服务器单独负责判断记号是什么及其含义，并在HTTP响应头中将其传送到客户端，以下是服务器端返回的格式：

ETag:"50b1c1d4f775c61:df3"

客户端的查询更新格式是这样的：

If-None-Match : W / "50b1c1d4f775c61:df3"

如果ETag没改变，则返回状态304然后不返回，这也和Last-Modified一样

# Etag - 作用
Etag 主要为了解决 Last-Modified 无法解决的一些问题。

1、一些文件也许会周期性的更改，但是他的内容并不改变(仅仅改变的修改时间)，这个时候我们并不希望客户端认为这个文件被修改了，而重新GET;

2、某些文件修改非常频繁，比如在秒以下的时间内进行修改，(比方说1s内修改了N次)，If-Modified-Since能检查到的粒度是s级的，这种修改无法判断(或者说UNIX记录MTIME只能精确到秒)

3、某些服务器不能精确的得到文件的最后修改时间；

为此，HTTP/1.1 引入了 Etag(Entity Tags).Etag仅仅是一个和文件相关的标记，可以是一个版本标记,比如说v1.0.0或者说"2e681a-6-5d044840"这么一串看起来 很神秘的编码。但是HTTP/1.1标准并没有规定Etag的内容是什么或者说要怎么实现

# etag生成的方式
## 强etag
强Etag根据配置文件中的配置来设置Etag值，默认的Apache的FileEtag设置为：

>FileEtag INode Mtime Size

也就是根据这三个属性来生成Etag值，他们之间通过一些算法来实现，并输出成hex的格式，相邻属性之间用-分隔，比如：

>Etag"2e681a-6-5d044840"

这里面的三个段，分别代表了INode，MTime，Size根据算法算出的值的Hex格式，(如果在这里看到了非Hex里面的字符(也就是0-f)，那你可能看见神了:))

当然，可以改变Apache的FileEtag设置，比如设置成FileEtagSize,那么得到的Etag可能为：

>Etag"6"

总之，设置了几个段，Etag值就有几个段。(不要误以为Etag就是固定的3段式)

说明

<p style="color:rgb(23,160,93)">
这里说的都是Apache2.2里面的Etag实现，因为HTTP/1.1并没有规定Etag必须是什么样的实现或者格式，因此，也可 以修改或者完全编写自己的算法得到Etag，比如"2e681a65d044840"，客户端会记住并缓存下这个Etag(Windows里面保存在哪 里，下次访问的时候直接拿这个值去和服务器生成的Etag对比。
</p>


注意
不管怎么样的算法，在服务器端都要进行计算，计算就有开销，会带来性能损失。因此为了榨干这一点点性能，不少网站完全把Etag禁用了(比如Yahoo!)，这其实不符合HTTP/1.1的规定，因为HTTP/1.1总是鼓励服务器尽可能的开启Etag。

## 弱etag
重新考虑前面提到的3个问题：

问题1、一些文件也许会周期性的更改，但是他的内容并不改变(仅仅改变的修改时间)，这个时候我们并不希望客户端认为这个文件被修改了，而重新GET;

>解决办法：如果使用强Etag，每次得会要求重新GET页面，如果使用Etag，比方说设置成 File Etag Size 等，就可以忽略 MTime 造成的 Last-Modified 时间修改从而影响了 If-Modified-Since(IMS) 这个校验了。这点和弱Etag无关。

问题2、某些文件修改非常频繁，比如在秒以下的时间内进行修改，(比方说1s内修改了N次)，If-Modified-Since能检查到的粒度是s级的，这种修改无法判断(或者说UNIX记录MTIME只能精确到秒)

>解决办法：如果是这种情况，Apache会自动判断请求时间和修改时间之间的差值，如果小于1s，Apache会认为这个文件在这1秒内可能会再次被修改， 因此生成一个弱Etag(WeakEtag),这个Etag仅仅基于MTime来生成，因此MTime只能精确到s，所以1s内生成的Etag总是一样， 这样就避免了使用强Etag造成的1s内频繁的刷新Cache的情况。(貌似不用Etag，仅仅使用Last-Modified就可以解决，但是这针对的 仅仅是修改超级频繁的情况，很多文件可能同时也使用强Etag验证)。弱Etag以W/开始，比如:W/"2e681a"

问题3、某些服务器不能精确的得到文件的最后修改时间；

>解决办法：生成Etag，因为Etag可以综合Inode，MTime和Size，可以避免这个问题